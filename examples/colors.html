<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>

        <style>
            main {
                text-align: center;
            }

            .box {
                display: inline-block;
                position: relative;
                width: 20em;
                max-width: 90vw;
                height: 10em;
                border: 1px solid black;
            }

            .box.white {
                color: white;
            }
            .box.predicted {
                box-shadow: 0 0 0 5px red;
            }

            .box h3 {
                margin: 0;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }
        </style>
    </head>
    <body>
        <main>
            <h1>Choose the more readable:</h1>
            <div class="box white" id="white-text">
                <h3>Hello World</h3>
            </div>
            <div class="box black" id="black-text">
                <h3>Hello World</h3>
            </div>
        </main>

        <script type="module">
            import { Network } from "../lib/index.js";
            import { softplus } from "../lib/activations.js";
            import { shuffle } from "../lib/helpers.js";

            let white = document.getElementById("white-text");
            let black = document.getElementById("black-text");
            const NORMALIZER = 255;

            let ranInt = (min, max) =>
                Math.floor(Math.random() * (max + 1 - min)) + min;

            let randomRGB = () => new Array(3).fill(0).map(_ => ranInt(0, 255));
            let normalizeRGB = color => color.map(c => c / NORMALIZER);
            let rgb = colors => `rgb(${colors.slice(0, 3).join(",")})`;

            function displayColor(color) {
                white.style.backgroundColor = rgb(color);
                black.style.backgroundColor = rgb(color);
            }

            function displayPrediction(predicted) {
                [white, black].forEach(box =>
                    box.classList.remove("predicted")
                );
                (predicted == 0 ? black : white).classList.add("predicted");
            }

            function picker() {
                return new Promise(resolve => {
                    let listener = ev => {
                        white.removeEventListener("click", listener);
                        black.removeEventListener("click", listener);

                        if (
                            [...ev.target.classList].includes("white") ||
                            [...ev.target.parentElement.classList].includes(
                                "white"
                            )
                        ) {
                            resolve(1);
                        } else resolve(0);
                    };

                    white.addEventListener("click", listener);
                    black.addEventListener("click", listener);
                });
            }

            function pick() {
                let currentColor = randomRGB();
                displayColor(currentColor);

                return [currentColor, picker];
            }

            async function quiz(times = 10, callback = () => "") {
                let choices = new Array(times).fill(0).map(_ => pick);
                let results = [];

                for (let pick of choices) {
                    let [color, userChoice] = pick();
                    callback(color);

                    let label = await userChoice();
                    results.push([color, label]);
                }

                return results;
            }

            async function main() {
                let ai = new Network([3, 3, 1], softplus)
                    .connect()
                    .addWeights()
                    .addBiases();

                let asked = 0;
                let results = [];

                while (true) {
                    let userChoices = await quiz(7, color => {
                        asked++;
                        if (asked > 7) {
                            let prediction = ai.predict(normalizeRGB(color))[0];
                            displayPrediction(Math.round(prediction));
                        }
                    });

                    results.push(...userChoices);
                    console.log("Training...");
                    for (let i = 0; i < 500; i++) {
                        shuffle(results).forEach(([color, label]) => {
                            ai.feed(normalizeRGB(color))
                                .run()
                                .backpropagate([label], 0.1, 1);
                        });
                    }
                    console.log("Done Training");
                }
            }
            main();
        </script>
    </body>
</html>
